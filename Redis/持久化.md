# Snapshotting （快照）

> 默认持久化方式是快照方式
>
> 将内存中的数据以快照方式写到二进制文件中，文件名默认是dump.rdb
>
> 可以配置redis在n秒内超过m个key被修改就自动做快照
>
> - save 900 1 #900 秒内如果超过 1 个 key 被修改，则发起快照保存
> - save 300 10 #300 秒内容如超过 10 个 key 被修改，则发起快照保存
>
> 快照保存过程
>
> 1. redis调用fork，有了父子进程
> 2. 父进程继续处理client请求，子进程将内容写到临时文件。
> 3. 子进程将快照写到临时文件完毕后，临时文件替换原来的快照文件，子进程退出。

# AOF方式

>快照方式保存数据时有一定的间隔时间，如果redis意外down机，会丢失掉一些数据，AOF则不会有这个问题。
>
>**AOF:**
>
>redis会将每个收到的写命令都会通过write函数追加到文件中。当redis重启时会重新执行文件保存的写命令来重建内存数据，由于 os 会在内核中缓存 write 做的修改，所以可能不是立即写到磁盘上。这样 aof 方式的持久化也还是有可能会丢失部分修改。
>
>可以配置持久化方式来避免：
>
>- appendonly yes //启用 aof 持久化方式
>
>- appendfsync always //收到写命令就立即写入磁盘，最慢，但是保证完全的持久化
>
>- appendfsync everysec //每秒钟写入磁盘一次，在性能和持久化方面做了很好的折中
>
>- appendfsync no //完全依赖 os，性能最好,持久化没保证

>aof 导致持久化文件越来越大的问题：
>
>可以通过brrewriteaof命令压缩持久化文件，收到这个命令后，redis将使用与快照类似的方式，将内存数据以命令的方式保存到临时文件中，最后替换原来的文件